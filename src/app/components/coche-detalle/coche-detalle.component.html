@if (coche$ | async; as coche) { @if (coche) {
<div class="container fade-in">
  <!-- 游댳 seguridad extra -->

  <div class="header-detalle">
    <h1 class="titulo">
      {{ coche.marca }} <span class="modelo">{{ coche.modelo }}</span>
    </h1>

    <div class="acciones">
      <!-- Solo admin ve editar y eliminar -->
      @if (authService.appUser$ | async; as user) { @if (user.rol === 'administrador') {
      <button mat-fab extended color="primary" [routerLink]="['/admin/form-coche', coche.id]">
        <mat-icon>edit</mat-icon>
        Editar Coche
      </button>
      } @if (user.rol === 'administrador') {
      <button mat-fab extended color="warn" (click)="deleteCar(coche.id)">
        <mat-icon>delete</mat-icon>
        Eliminar
      </button>
      } }
    </div>
  </div>

  <div class="contenido-principal">
    <div class="imagen-wrapper">
      <img
        [src]="
          coche.fotoPrincipal && coche.fotoPrincipal.length > 5
            ? coche.fotoPrincipal
            : 'assets/proximamente.png'
        "
        class="img-principal"
        alt="Foto principal"
        (click)="abrirImagen(coche.fotoPrincipal || 'assets/proximamente.png', 'Foto principal')"
      />
    </div>

    <div class="ficha-tecnica">
      <h2>Especificaciones</h2>

      <div class="dato-item">
        <span class="label">A침o</span>
        <span class="valor">{{ coche.anio }}</span>
      </div>

      <div class="dato-item">
        <span class="label">Cambio</span>
        <span class="valor">{{ coche.cambio }}</span>
      </div>

      <div class="dato-item">
        <span class="label">Combustible</span>
        <span class="valor">{{ coche.combustible }}</span>
      </div>

      @if (coche.tipo?.length) {
      <div class="dato-item">
        <span class="label">Carrocer칤a</span>
        <span class="valor">{{ coche.tipo?.join(', ') }}</span>
      </div>
      } @if (coche.kilometraje !== undefined) {
      <div class="dato-item">
        <span class="label">Kilometraje</span>
        <span class="valor">{{ coche.kilometraje }} km</span>
      </div>
      } @if (coche.motor) {
      <div class="dato-item">
        <span class="label">Motor</span>
        <span class="valor">{{ coche.motor }}</span>
      </div>
      } @if (coche.precio) {
      <div class="precio-tag">
        {{ coche.precio | currency : 'EUR' }}
      </div>
      } @if (authService.appUser$ | async; as user) {
      <div class="reserva-wrapper">
        <!-- Bot칩n normal de reservar para usuarios -->
        @if (!coche.reservadoPor && user.rol !== 'administrador') {
        <button
          mat-flat-button
          color="primary"
          class="btn-reservar-full"
          (click)="ejecutarReserva(coche.id)"
        >
          <mat-icon>event_available</mat-icon>
          Reservar ahora
        </button>
        }

        <!-- Si ya est치 reservado -->
        @if (coche.reservadoPor) {
        <div class="aviso-reservado">
          <mat-icon>lock</mat-icon>
          <span>Veh칤culo no disponible (Reservado)</span>

          @if (user.rol === 'administrador' && coche.reservadorNombre) {
          <div>
            <small>Reservado por: {{ coche.reservadorNombre }}</small>
          </div>
          }

          <!-- ADMIN: bot칩n para quitar reserva -->
          @if (user.rol === 'administrador') {
          <button mat-stroked-button color="warn" (click)="removeReserva(coche.id)">
            <mat-icon>lock_open</mat-icon>
            Quitar reserva
          </button>
          }
        </div>
        }
      </div>
      }
    </div>
  </div>

  <div class="galeria-section">
    <h3>Galer칤a de Im치genes</h3>
    <div class="fotos-grid">
      @if (coche.fotos?.length) { @for (fotoUrl of coche.fotos; track fotoUrl) {
      <div class="foto-card">
        <img
          [src]="fotoUrl"
          alt="Foto galer칤a"
          class="clickable-img"
          (click)="abrirImagen(fotoUrl, 'Foto galer칤a')"
        />
      </div>
      } } @else {
      <div class="sin-fotos">
        <p>Im치genes disponibles muy pronto</p>
      </div>
      }
    </div>
  </div>
</div>
} @else {
<div class="loading-container">
  <mat-spinner diameter="50"></mat-spinner>
  <p>Cargando coche...</p>
</div>
} }
