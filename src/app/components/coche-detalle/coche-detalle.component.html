<ng-container *ngIf="coche$ | async as coche; else loading">
  <div *ngIf="coche" class="container fade-in"> <!-- 游댳 seguridad extra -->
    <div class="header-detalle">
      <h1 class="titulo">
        {{ coche.marca }} <span class="modelo">{{ coche.modelo }}</span>
      </h1>

      <div class="acciones">
        <!-- Solo admin ve editar y eliminar -->
        <ng-container *ngIf="authService.appUser$ | async as user">
          <button 
            *ngIf="user.rol === 'administrador'"
            mat-fab 
            extended 
            color="primary" 
            [routerLink]="['/admin/form-coche', coche.id]">
            <mat-icon>edit</mat-icon>
            Editar Coche
          </button>

          <button 
            *ngIf="user.rol === 'administrador'"
            mat-fab 
            extended 
            color="warn"
            (click)="deleteCar(coche.id)">
            <mat-icon>delete</mat-icon>
            Eliminar
          </button>
        </ng-container>
      </div>
    </div>

    <div class="contenido-principal">
      <div class="imagen-wrapper">
        <img 
          [src]="(coche.fotoPrincipal && coche.fotoPrincipal.length > 5) ? coche.fotoPrincipal : 'assets/proximamente.png'" 
          class="img-principal" 
          alt="Foto principal" (click)="abrirImagen(coche.fotoPrincipal || 'assets/proximamente.png', 'Foto principal')"/>
      </div>

      <div class="ficha-tecnica">
        <h2>Especificaciones</h2>

        <div class="dato-item">
          <span class="label">A침o</span>
          <span class="valor">{{ coche.anio }}</span>
        </div>
        <div class="dato-item">
          <span class="label">Cambio</span>
          <span class="valor">{{ coche.cambio }}</span>
        </div>
        <div class="dato-item">
          <span class="label">Combustible</span>
          <span class="valor">{{ coche.combustible }}</span>
        </div>

        <div class="dato-item" *ngIf="coche.tipo?.length">
          <span class="label">Carrocer칤a</span>
          <span class="valor">{{ coche.tipo?.join(', ') }}</span>
        </div>

        <div class="dato-item" *ngIf="coche.tipo?.length">
          <span class="label">Kilometraje</span>
          <span class="valor">{{ coche.kilometraje }} km</span>
        </div>

        <div class="dato-item" *ngIf="coche.tipo?.length">
          <span class="label">Motor</span>
          <span class="valor">{{ coche.motor }}</span>
        </div>

        <div class="precio-tag" *ngIf="coche.precio">
          {{ coche.precio | currency:'EUR' }}
        </div>

        <div class="reserva-wrapper" *ngIf="authService.appUser$ | async as user">
          <!-- Bot칩n normal de reservar para usuarios -->
          <button *ngIf="!coche.reservadoPor" mat-flat-button color="primary" class="btn-reservar-full" (click)="ejecutarReserva(coche.id)">
            <mat-icon>event_available</mat-icon>
            Reservar ahora
          </button>

          <!-- Si ya est치 reservado -->
          <div *ngIf="coche.reservadoPor" class="aviso-reservado">
            <mat-icon>lock</mat-icon>
            <span>Veh칤culo no disponible (Reservado)</span>

            <!-- Mostrar nombre del usuario que reserv칩 -->
            <div *ngIf="user.rol === 'administrador' && coche.reservadorNombre">
              <small>Reservado por: {{ coche.reservadorNombre }}</small>
            </div>

            <!-- ADMIN: bot칩n para quitar reserva -->
            <button *ngIf="user.rol === 'administrador'" mat-stroked-button color="warn" (click)="removeReserva(coche.id)">
              <mat-icon>lock_open</mat-icon>
              Quitar reserva
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="galeria-section">
      <h3>Galer칤a de Im치genes</h3>
      <div class="fotos-grid">

        <!-- Si hay fotos, mostramos normalmente -->
        <ng-container *ngIf="coche.fotos?.length; else noFotosGaleria">
          <div class="foto-card" *ngFor="let fotoUrl of coche.fotos">
            <img [src]="fotoUrl" alt="Foto galer칤a" class="clickable-img" (click)="abrirImagen(fotoUrl, 'Foto galer칤a')"/>
          </div>
        </ng-container>

        <!-- Bloque alternativo cuando NO hay fotos -->
        <ng-template #noFotosGaleria>
          <div class="sin-fotos">
            <p>Im치genes disponibles muy pronto</p>
          </div>
        </ng-template>
      </div>
    </div>
  </div>
</ng-container>

<ng-template #loading>
  <div class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Cargando coche...</p>
  </div>
</ng-template>